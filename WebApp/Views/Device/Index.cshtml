@using DAO.BaseModels
@using DAO.Models.Devices
@model IEnumerable<DAO.BaseModels.Device>
@{
    ViewBag.Title = "title";
    Layout = "MyLayout";
}
@await Component.InvokeAsync("DeviceCreate")
@if (ViewBag.RoomName != null)
{
    <h1>@ViewBag.RoomName</h1>
}
<ul class="box-info" id="boxInfoList">
    @foreach (var device in Model)
    {
        // check if device instance of Light
        if (device is Light)
        {
            <li>
                <span class="textlight">
                    <div class="text ">
                        <h3>@device.Name</h3>
                        <div class="lamp-wrapper-main">
                            <div class="lamp-rope"></div>
                            <div class="lamp-inner">
                                <div class="lamp-main lamp-bottom"></div>
                                <div class="lamp-blub"></div>
                            </div>
                        </div>
                        <form oninput="document.body.setAttribute('data-light', slider.value)" class="lamp-input">
                            <label for="slider" class="slider-label">Độ sáng:</label>
                            <div class="slider-container">
                                <div class="icon-sun">
                                    <i class='bx bxs-sun'></i>
                                </div>
                                <input type="range" id="slider" value="0" min="0" max="10" class="slider">
                            </div>
                        </form>
                        <button type="button" id="toggle-button" class="toggle-btn">Bật/Tắt</button>
                    </div>
                </span>
            </li>
        }

        if (device is Fan)
        {
            <li>
                <span class="textfan">
                    <div class="text ">
                        <h3>@device.Name</h3>
                        <div class="part">
                            <div class="box">
                                <img src="https://cdn-icons-png.flaticon.com/512/95/95252.png" width="100%" height="100%">
                                <div class="box1"></div>
                            </div>
                        </div>
                        <form class="fan-input">
                            <div class="on">
                                <img src="pic/power.png" width="100%">
                            </div>
                            <div class="off">
                                <img src="pic/power-button.png" width="100%">
                            </div>

                        </form>
                        <div>
                            <button class="speed-button" data-speed="0.8">1</button>
                            <button class="speed-button" data-speed="0.2">2</button>

                        </div>
                    </div>
                </span>
            </li>
        }

        if (device is RgbLight)
        {
            <li>
                <span class="textlight">
                    <div class="text ">
                        <h3>@device.Name</h3>
                        <div class="rgb-light">
                            <div class="rgb-color"></div>
                        </div>
                        <form class="rgb-input">
                            <label for="color-picker" class="color-label">Chọn màu:</label>
                            <input type="color" id="color-picker" value="#ff0000">
                            <button type="button" id="toggle-button" class="toggle-btn">Bật/Tắt</button>
                        </form>

                    </div>
                </span>
            </li>
        }
    }
</ul>
@section Scripts {
    <script>
        $(document).ready(function() {
            var skip = @Model.Count();
            var take = 3; // Number of items to load each time
            var isLoading = false; // Prevent multiple requests
            var allItemsLoaded = false; // Flag to indicate all items are loaded

            $('main').on('scroll', function() {
                if ($(window).scrollTop() + $(window).height() >= $(document).height()  && !isLoading) {
                    if (!allItemsLoaded) {
                        loadMoreDevices();
                    }
                }
            });

            function loadMoreDevices() {
                isLoading = true;
                $("#loading").show();
                setTimeout(function() { // Add delay
                    $.ajax({
                        url: '@Url.Action("LoadMoreDevices", "Device")',
                        type: 'GET',
                        data: { skip: skip, take: take },
                        success: function (result) {
                            if (result.trim() === "") {
                                // No more items to load
                                allItemsLoaded = true;
                            } else {
                                $("#boxInfoList").append(result);
                                skip += take;
                            }
                            isLoading = false;
                            $("#loading").hide();
                        },
                        error: function () {
                            isLoading = false;
                            $("#loading").hide();
                        }
                    });
                }, 500); // Delay of 500ms
            }
            
            $('button.search-btn').click(function(event) {
                event.preventDefault();
                var keyword = $('#keyword').val();
                $.ajax({
                    url: '@Url.Action("Search", "Device")',
                    type: 'GET',
                    data: { keyword: keyword },
                    success: function(data) {
                        // Assuming you have a div with id 'searchResults' to display the results
                        $('#boxInfoList').html(data);
                    },
                    error: function() {
                        alert('Error occurred while searching.');
                    }
                });
            });
        });
    </script>
}
